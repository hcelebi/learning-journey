@Library('jenkinsfile-sharedlibraries@master')

def scmUrl = scm.getUserRemoteConfigs()[0].getUrl()
Map gitVars
def (GROUP, REPOSITORY) = JOB_NAME.toLowerCase().split("/")

def DOCKER_IMAGE_NAME = "learning-journey"

String SHORT_BRANCH_NAME
String DOCKER_IMAGE_VERSION

pipeline {
    agent {
        label 'dockerbuilder'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '15', artifactNumToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        gitLabConnection('gitlab-connection')
        disableConcurrentBuilds()
        skipDefaultCheckout()
    }

    environment {
        DOCKER_GID = 990
    }

    triggers {
        gitlab(
                triggerOnPush: true,
                triggerOnMergeRequest: false,
                triggerOpenMergeRequestOnPush: "never",
                triggerOnNoteRequest: true,
                noteRegex: "retry",
                skipWorkInProgressMergeRequest: false,
                ciSkip: true,
                setBuildDescription: true,
                addNoteOnMergeRequest: true,
                addCiMessage: true,
                addVoteOnMergeRequest: true,
                acceptMergeRequestOnSuccess: false,
                branchFilterType: "RegexBasedFilter",
                sourceBranchRegex: '(feature/.*|master|hotfix.*|bug/.*|improvement/.*|merge/.*)',
                cancelPendingBuildsOnUpdate: true,
                secretToken: "")
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    sh "printenv"
                    echo 'Checkout stage started'
                    deleteDir()
                    gitVars = checkout([$class                           : 'GitSCM',
                                        branches                         : scm.branches,
                                        doGenerateSubmoduleConfigurations: false,
                                        extensions                       : [
                                                [$class: 'AuthorInChangelog'],
                                                [$class: 'CleanBeforeCheckout'],
                                                [$class: 'UserIdentity', email: 'dl-gg-phnx@ebay.com', name: 'jenkins'],
                                                [$class: 'PreBuildMerge', options: [mergeRemote: 'origin', mergeTarget: 'master']]
                                        ],
                                        submoduleCfg                     : [],
                                        userRemoteConfigs                : [[credentialsId: '54a495be-9f2a-4178-be2e-5f06753bb118', url: "$scmUrl"]]])
                    echo 'Checkout stage completed'
                }
            }
        }

        stage("sh") {
            steps {
                script {
                    sh "pwd"
                    sh "ls -la $WORKSPACE"
                }
            }
        }

        stage("Docker Build") {
            steps {
                script {
                    sh "docker build --pull -t $DOCKER_IMAGE_NAME:${env.BUILD_NUMBER} ."
                }
            }
        }

        stage("Docker Push") {
            parallel {
                stage("Docker Push (Office)") {
                    steps {
                        script {
                            pushToRegistry("${env.REGISTRY_TEST}", "$DOCKER_IMAGE_NAME", "${env.BUILD_NUMBER}")
                        }
                    }
                }
            }
            post {
                always {
                    sh "docker rmi $DOCKER_IMAGE_NAME:${env.BUILD_NUMBER}"
                }
            }
        }

        /*
        stage("Deploy To Test Cluster") {
            steps {
                script {
                    sh "docker run -v '$WORKSPACE/kube:/opt/kube'  bitnami/kubectl:1.20.2  apply -f /opt/kube/deployment.yaml -f /opt/kube/service.yaml -n phnx --kubeconfig /opt/kube/config"
                }
            }
        }
*/
        stage("Deploy To Test Cluster With Agent") {
            agent {
                kubernetes {
                    cloud 'kubernetes-preprod'
                    label 'learning-journey-dev-deploy'
                    defaultContainer 'kubectl'
                    yaml """
                    apiVersion: v1
                    kind: Pod
                    metadata:
                      labels:
                        goal: deploy
                    spec:
                      securityContext:
                        runAsUser: 0
                      containers:
                        - name: kubectl
                          image: lachlanevenson/k8s-kubectl
                          resources:
                            requests:
                              memory: 100Mi
                              cpu : 250m
                            limits:
                              memory: 300Mi
                              cpu : 250m
                          command:
                            - cat
                          tty: true
                    """
                }
            }
            steps {
                script {
                    sh "kubectl  apply -f ${WORKSPACE}/kube/deployment.yaml -f ${WORKSPACE}/kube/service.yaml -n phnx"
                }
            }
        }
    }
}